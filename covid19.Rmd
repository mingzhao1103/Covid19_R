---
title: "The Effects of Booster on Weekly New Cases at the County Level in the U.S"
author: "Ming Zhao (919024805)"
date: "Mar 14, 2022"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r,echo=FALSE,results='hide'}

library(tidyverse)
library(dplyr)
library(ggplot2)
library(zoo)
library(lubridate)
library(tidyquant)
library(grkmisc)
library(maps)
library(usmap)
library(gridExtra)
library(ggpubr)
library(lme4)
library(car)
library(lmerTest)
library(lmPerm)
library(MASS)
library(performance)
library(knitr)
library(kableExtra)
library(stargazer)

```

```{r,echo=FALSE,results='hide'}

# Data Loading

setwd("/Users/mingzhao/Desktop/Covid-19")

covid <- read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")
covid_states <- read_csv("COVID-19_Cases_State.csv")
vaccine <- read_csv("COVID-19_Vaccinations.csv")
cases <- read_csv("COVID-19_Cases.csv")
cum_cases <- read_csv("COVID-19_Cumulatives.csv")
density <- read_csv("Density.csv")
income <- read_csv("Income.csv")
demographics <- read_csv("Demographics.csv")

```

```{r,echo=FALSE,results='hide'}

# vaccine data
glimpse(vaccine)

## convert date format
vaccine$Date <- as.Date(vaccine$Date, format = "%m/%d/%Y")
class(vaccine$Date)

## rename variables
names(vaccine)[c(2:5)] <- c("fips", "week", "county", "state") 

## filter data
sum(vaccine$fips=="UNK")
vaccine <- subset(vaccine, fips != "UNK")

## generate longitudinal data
vaccines <- subset(vaccine, Date == "2022-02-05",
                   select = c(Date, fips, week, county, state, Metro_status,
                              Census2019, Series_Complete_Pop_Pct, 
                              Booster_Doses,Booster_Doses_Vax_Pct, 
                              Booster_Doses_12Plus, Booster_Doses_18Plus, 
                              Booster_Doses_50Plus, Booster_Doses_65Plus,
                              Booster_Doses_12Plus_Vax_Pct, Booster_Doses_18Plus_Vax_Pct,
                              Booster_Doses_50Plus_Vax_Pct, Booster_Doses_65Plus_Vax_Pct))

```

```{r,echo=FALSE,results='hide'}

# case data
glimpse(cases)

## convert date format
cases$date <- as.Date(cases$date, format = "%m/%d/%Y")
class(cases$date)

## filter data
cases <- subset(cases, date == "2022-02-19")

## create new variables
cases$cases_per_100K_7_day_count_change <- gsub("\\,", "", as.character(cases$cases_per_100K_7_day_count_change))
cases$cases_per_100K_7_day_count_change <- as.numeric(cases$cases_per_100K_7_day_count_change)
cases$fips <- cases$fips_code

## check outliers
cases[order(cases$cases_per_100K_7_day_count_change, decreasing =TRUE)[c(1:10)],] #fips=46041, 46137, 21129, 02180, 21063
vaccines[vaccines$fips == "46041",]$Census2019  #5892
vaccines[vaccines$fips == "46137",]$Census2019  #2756
vaccines[vaccines$fips == "21129",]$Census2019  #7403
vaccines[vaccines$fips == "02180",]$Census2019  #10004
vaccines[vaccines$fips == "21063",]$Census2019  #7517

## filter data
cases <- subset(cases, select = c("fips", "cases_per_100K_7_day_count_change"))

sum(is.na(cases$cases_per_100K_7_day_count_change))
dim(cases)

```

```{r,echo=FALSE,results='hide'}

# demographic data

density$fips <- density$GEOID
demo1 <- subset(density, select = c(fips, B25010_001E, B01001_calc_PopDensity))
names(demo1)[c(2:3)] <- c("hh_size", "pop_density")  #average household size, Population Density (people per square kilometer)

glimpse(income)
income$fips <- income$FIPS_Code
demo2 <- subset(income, select = c(fips, Median_Household_Income_2019))
names(demo2)[2] <- c("hh_income") 

demographics$fips <- sprintf("%05d", demographics$`FIPS code`)
demo3 <- subset(demographics, select = c("fips", "% In Poverty", "% Over Age 65", "% Non-Hispanic Black",
                                         "% Hispanic", "% Non-Hispanic Native American / Alaskan Native",
                                         "% Non-Hispanic Asian"))
names(demo3)[c(2:7)] <- c("poverty_pct", "over_65_pct", "black_pct", "hispanic_pct", "native_pct", "asian_pct")

```

```{r,echo=FALSE,results='hide'}

# final data

data0 <- vaccines %>% left_join(demo1, by=c("fips"))
data0 <- data0 %>% left_join(demo2, by=c("fips"))
data0 <- data0 %>% left_join(demo3, by=c("fips"))

data <- data0 %>% left_join(cases, by=c("fips"))

data$booster_pop_pct_2 <- data$Booster_Doses/data$Census2019

data$complete_pop_pct <- data$Series_Complete_Pop_Pct
data$booster_vax_pct <- data$Booster_Doses_Vax_Pct

data$booster_00_12 <- data$Booster_Doses - data$Booster_Doses_12Plus
data$booster_12_18 <- data$Booster_Doses_12Plus - data$Booster_Doses_18Plus
data$booster_18_50 <- data$Booster_Doses_18Plus - data$Booster_Doses_50Plus
data$booster_50_65 <- data$Booster_Doses_50Plus - data$Booster_Doses_65Plus
data$booster_65_99 <- data$Booster_Doses_65Plus

data$booster_00_12_vax_pct <- data$booster_00_12/data$complete_pop_pct
data$booster_12_18_vax_pct <- data$booster_12_18/data$complete_pop_pct
data$booster_18_50_vax_pct <- data$booster_18_50/data$complete_pop_pct
data$booster_50_65_vax_pct <- data$booster_50_65/data$complete_pop_pct
data$booster_65_99_vax_pct <- data$booster_65_99/data$complete_pop_pct

data$booster_12_vax_pct <- data$Booster_Doses_12Plus_Vax_Pct
data$booster_18_vax_pct <- data$Booster_Doses_18Plus_Vax_Pct
data$booster_50_vax_pct <- data$Booster_Doses_50Plus_Vax_Pct
data$booster_65_vax_pct <- data$Booster_Doses_65Plus_Vax_Pct

df <- subset(data, select = c(cases_per_100K_7_day_count_change, 
                              state,
                              booster_pop_pct_2, 
                              booster_00_12_vax_pct, booster_12_18_vax_pct,
                              booster_18_50_vax_pct, booster_50_65_vax_pct,
                              booster_65_99_vax_pct,
                              complete_pop_pct, booster_vax_pct, 
                              booster_12_vax_pct, booster_18_vax_pct, 
                              booster_50_vax_pct, booster_65_vax_pct,
                              hh_size, pop_density, hh_income, poverty_pct, over_65_pct, 
                              black_pct, hispanic_pct, native_pct, asian_pct, Metro_status))
names(df)[1] <- c("new_cases")
dim(df) #3224

#sum(is.na(df$new_cases))  # 380
#df <- df[complete.cases(df$new_cases),]
#sum(is.na(df$complete_pop_pct)) #0
#sum(is.na(df$booster_vax_pct)) #8
#df <- df[complete.cases(df$booster_vax_pct),]

df_reg <- subset(df, select = c(new_cases, booster_vax_pct, 
                                black_pct, hispanic_pct, asian_pct, pop_density, Metro_status, state))

df_reg <- df_reg[complete.cases(df_reg),]
dim(df_reg) #2762

df_reg$log_new_cases <- log(df_reg$new_cases + 1)

```

```{r,echo=FALSE,results='hide'}

# WHO data
glimpse(covid)

## new cases
covid.daily <- covid %>% 
                     group_by(Date_reported) %>% 
                     summarise(daily_newcases = sum(New_cases), 
                               daily_cumcases = sum(Cumulative_cases))
covid.daily$avg_daily_newcases <- stats::filter(covid.daily$daily_newcases, rep(1/7, 7), sides = 1)
covid.daily <- covid.daily %>% filter(Date_reported < "2022-02-20")

## cumulative cases by country
covid.today<- covid %>% 
  filter(Date_reported == "2022-02-19") %>% 
  mutate(Country.Region=Country)

world <- map_data("world")

covid.today$Country.Region[!covid.today$Country.Region %in% world$region]

list <- which(!covid.today$Country.Region %in% world$region)

covid.today$country <- as.character(covid.today$Country.Region)

covid.today$country[list] <-
  c("Antigua", "Bolivia", "Virgin Islands",
    "Brunei", "Cape Verde", "Democratic Republic of the Congo",
    "Ivory Coast", "Curacao", "Czech Republic",
    "North Korea", "Swaziland", "Falkland Islands",
    "Gibraltar", "Holy See", "Iran",
    "Kosovo", "Laos", "Micronesia",
    "Northern Mariana Islands", "Palestine", "Other",
    "South Korea", "Moldova", "Reunion",
    "Russia", "Saint Barthelemy", "Saint Kitts",
    "Saint Vincent", "Syria", "UK",
    "Tokelau", "Trinidad", "Tuvalu",
    "Tanzania", "USA", "Virgin Islands",
    "Venezuela", "Vietnam")

covid.today$Country.Region[!covid.today$country %in% world$region]

world$country <- world$region

worldmap <- left_join(world, covid.today, by="country")

worldmap$Cumulative_cases[is.na(worldmap$Cumulative_cases)] <- 0

summary(covid.today$Cumulative_cases)

table(covid.today[covid.today$Cumulative_cases > 50000000,]$Country)
covid.today$Cumulative_cases[covid.today$Cumulative_cases > 50000000] <- 55000000


worldmap$Cumulative_case[worldmap$Cumulative_case > 50000000] <- 55000000

worldmap$cum_case_100k <- worldmap$Cumulative_case/100000

worldmap <- subset(worldmap, group < 25 | group >132)

```

```{r,echo=FALSE,results='hide'}

# USA data
glimpse(covid)
glimpse(covid_states)

## new cases
covid.us <- subset(covid, Country == "United States of America" & Date_reported < "2022-02-20")
covid.us$avg_newcases <- stats::filter(covid.us$New_cases, rep(1/7, 7), sides = 1)

## new cases by state
covid_states$date <- as.Date(covid_states$submission_date, format = "%m/%d/%Y")
class(covid_states$date)
covid.state <- subset(covid_states, date < "2022-02-20", 
                      select = c(date, state, new_case) )

covid.state <- covid.state[covid.state$state %in% unique(data$state),]

state <- sort(unique(df_reg$state))

cum_cases <- read_csv("COVID-19_Cumulatives.csv")
## cumulative cases by county
glimpse(cum_cases)

class(cum_cases$date)
cum.cases <- subset(cum_cases, date == "2022-02-19", select = c(fips, state, county, cases))

sum(is.na(cum.cases$cases))
sum(is.na(cum.cases$fips))
sum(is.na(cum.cases$state))
sum(is.na(cum.cases$county))

cum.cases$state <- tolower(cum.cases$state)
cum.cases$county <- tolower(cum.cases$county)

mainstates <- map_data("state")
allcounty <- map_data("county")

glimpse(allcounty)

names(allcounty)[5:6] <- c("state", "county")

unique(allcounty$county[!allcounty$county %in% cum.cases$county])

cum.cases$county <- gsub("\\.", "", as.character(cum.cases$county))

cum.cases$fips[cum.cases$county=="new york city"] <- "99999"
cum.cases$county[cum.cases$county=="new york city"] <- "new york"

cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "01049", "dekalb" = "de kalb")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "17043", "dupage" = "du page")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "18091", "laporte" = "la porte")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "19141", "o'brien" = "obrien")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "24033", "prince george's" = "prince georges")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "24035", "queen anne's" = "queen annes")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "24037", "st mary's" = "st marys")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "38045", "lamoure" = "la moure")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "46102", "oglala lakota" = "oglala dakota")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "51700", "newport news city" = "newport news")
cum.cases$county <-recode_if(cum.cases$county, cum.cases$fips == "51810", "virginia beach city" = "virginia beach")

unique(allcounty$county[!allcounty$county %in% cum.cases$county])

all.county <- allcounty %>% left_join(cum.cases, by=c("state", "county"))

summary(cum.cases$cases)
cum.cases$cases[cum.cases$cases > 100000] <- 100000

sum(is.na(all.county$cases))

all.county$cases[all.county$cases > 100000] <- 110000

all.county$cases_100k <- all.county$cases/100000

```

# Introduction {-}

The omicron variant becomes the dominate strain of COVID-19 since December 2021, and it is more infectious than Delta among vaccinated and boosted people [(ref1)](https://www.health.com/condition/infectious-diseases/coronavirus/omicron-vs-delta). Plotting the global data from WHO in Figure 1, the new cases significantly increased due to the omicron variant from then on ([data1](https://covid19.who.int/)). In the worldwide growth, the U.S takes up the most cumulative cases, as shown in Figure 2. By further looking at the U.S. in Figure 3, the growth pattern is similar with the global. As the Figure 4 shows, the data at the state level also show a similar pattern ([data2](https://github.com/nytimes/covid-19-data)).    

As a consequence, I am curious about whether vaccinations, specifically boosters, are still effective against infection in the U.S. This project focuses on the effects of booster rate on weekly new COVID-19 cases at the county level. The goal is to examine whether the percent of people who are fully vaccinated and have received a booster dose is associated with the most recent cases within the last 7 days. Linear regression and Negative Binomial Regression are the two methods proposed for studying the count data. Additionally, I include demographic features in the models, such as population density, race distribution, metro status. In the following, I first introduce the data I use, explore the data using descriptive statistics, fit models with diagnostics, and finally draw a conclusion. 
\ 

```{r,echo=FALSE}

# World plot 1
ggplot(covid.daily, aes(x=Date_reported, y=daily_newcases)) + 
  geom_bar(stat="identity", width=0.8, color = "grey") +
  geom_line(aes(y=avg_daily_newcases), size = 1, color = "blue") + 
  theme_classic() +
  theme_bw() +
  labs(title = "Figure1. Covid-19 Global Daily New Cases", x= "Date", y= "New cases") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold")) +
  scale_x_date(limits = as.Date(c("2020-01-09", "2022-02-19")), date_breaks = "1 month", date_labels = "%y-%m")

# World plot 2
fig.map  <- ggplot() +
  geom_polygon(data = worldmap, aes(x=long, y = lat, group = group, fill=cum_case_100k), 
               color="black", size = 0.1) + 
  scale_fill_continuous(name="", 
                        low = "lightblue", 
                        high = "darkblue",
                        limits = c(0,550), 
                        breaks = seq(0, 500, 100)) +
  ggtitle("Figure2. World Map of Cumulative Cases", subtitle="Total Cases Per 100K People on Feb 19, 2022") +
  coord_fixed(1.3) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),        
        legend.position="right",
        legend.key.size = unit(0.8, "cm"))
fig.map

```
```{r,echo=FALSE}

# US plot 1
ggplot(covid.us, aes(x=Date_reported, y=New_cases)) + 
  geom_bar(stat="identity", width=0.1, color = "grey") +
  geom_line(aes(y=avg_newcases), size = 1, color = "blue") + 
  theme_classic() +
  theme_bw() +
  labs(title = "Figure3. Covid-19 Daily New Cases in USA", x= "Date", y= "New cases") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold")) +
  scale_x_date(limits = as.Date(c("2020-01-09", "2022-02-19")), date_breaks = "1 month", date_labels = "%y-%m")

```

\ 
```{r,echo=FALSE}
# US plot 2
state1 <-
ggplot(covid.state[covid.state$state %in% state[c(3:6, 8, 10)],], 
       aes(x=date, y=new_case)) + 
  coord_cartesian() +
  geom_smooth(method="loess", se=F) +
  facet_wrap(~state, scales = "free", ncol = 6) + 
  theme_classic() +
  theme_bw() +
  labs(title = "", x= "", y= "") +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.margin=unit(c(-0.4,0,0,-0.3), "cm")) +
  scale_x_date(limits = as.Date(c("2020-01-09", "2022-02-19")), date_labels = "%y-%m")

state2 <-
  ggplot(covid.state[covid.state$state %in% state[c(14, 19, 21, 25, 26, 29)],], 
         aes(x=date, y=new_case)) + 
  coord_cartesian() +
  geom_smooth(method="loess", se=F) +
  facet_wrap(~state, scales = "free", ncol = 6) + 
  theme_classic() +
  theme_bw() +
  labs(title = "", x= "", y= "") +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.margin=unit(c(-0.4,0,0,-0.3), "cm")) +
  scale_x_date(limits = as.Date(c("2020-01-09", "2022-02-19")), date_labels = "%y-%m")

state3 <-
  ggplot(covid.state[covid.state$state %in% state[c(32, 33, 36, 41, 42, 45)],], 
         aes(x=date, y=new_case)) + 
  coord_cartesian() +
  geom_smooth(method="loess", se=F) +
  facet_wrap(~state, scales = "free", ncol = 6) + 
  theme_classic() +
  theme_bw() +
  labs(title = "", x= "", y= "") +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.margin=unit(c(-0.4,0.3,0,-0.3), "cm")) +
  scale_x_date(limits = as.Date(c("2020-01-09", "2022-02-19")), date_labels = "%y-%m")

title=text_grob("Figure4. Covid-19 Daily New Cases by State (Selected)", size = 14, face = "bold") 
grid.arrange(state1, state2, state3, ncol=1, top = title, left = "New cases", bottom = "Date")

```

# Background {-}

Figure 5 displays the cumulative cases by county and well shows the variation of infection among the counties ([data2](https://github.com/nytimes/covid-19-data)). In this project, I use the the U.S data at the county level. For the purpose of conducting the analysis, I first combine the case data ([data3](https://data.cdc.gov/Public-Health-Surveillance/United-States-COVID-19-County-Level-of-Community-T/nra9-vzzn)) and vaccination data ([data4](https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-County/8xkx-amqh)) from CDC. Then I collect demographic features about the counties: population density from Census ([data5](https://data.census.gov/cedsci/table?q=United%20States&t=-00%20-%20All%20available%20races&g=0100000US%240500000&tid=ACSSPP1Y2019.S0201)), race distribution, including Black percent, Hispanic percent, and Asian percent from Health Data ([data6](https://healthdata.gov/Health/COVID-19-Community-Profile-Report/gqxm-d9w9)). State and metro status are also added in the model and CDC provide such information in the vaccination data. Specifically, the outcome variable is weekly new cases defined as the total new cases from “2022-02-12” to “2022-02-19” per 100K people. The variable of interest is booster rate defined as the total number of people who are fully vaccinated and have received a booster shot divided by the total number of people who are fully vaccinated (have second dose of a two-dose vaccine or one dose of a single-dose vaccine), according to CDC ([ref2](https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-County/8xkx-amqh)).

The date of booster rate I use in the model is two week before the date of new cases, which is "2022-02-05" because it takes two weeks for booster to be effective ([ref3](https://www.health.com/condition/infectious-diseases/coronavirus/how-long-does-it-take-for-the-booster-to-be-effective)). My hypothesis is that although the omicron variant becomes dominant, the booster still works for its function. According to [Hill and Artiga](https://www.kff.org/coronavirus-covid-19/issue-brief/covid-19-cases-and-deaths-by-race-ethnicity-current-data-and-changes-over-time/), ethnicity minority is associated with more proportion of COVID-19 cases and deaths, so my hypothesis is that the more percent of Black, Hispanic, and Asian a county has, the more new cases the county has. For the population density, based on the study by [Wong and Li](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0242398), population density matters the COVID-19 cumulative cases at the county level to a certain extent, so my hypothesis is that, higher population density is positively associated with more new cases because I assume more contacts indicate more chance of infection, and it is similar for metro status. 

```{r,echo=FALSE}

# US plot 3
fig.map  <- ggplot() +
  geom_polygon(data = all.county, aes(x=long, y = lat, group = group, fill=cases_100k), 
               color="grey", size = 0.2) + 
  geom_polygon( data=mainstates, aes(x=long, y=lat, group=group),
                color="black", fill="lightblue", size = 0.3, alpha = 0.3)+
  scale_fill_continuous(name="", 
                        low = "lightblue", 
                        high = "darkblue",
                        limits = c(0, 1.1), 
                        breaks = seq(0, 1, 0.25)) +
  ggtitle("Figure5. USA Map of Cumulative Cases", subtitle="Total Cases Per 100K People on Feb 19, 2022") +
  coord_fixed(1.3) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),        
        legend.position="right",
        legend.key.size = unit(0.8, "cm"))
fig.map

```

# Descriptive Analysis {-}

#### Univariate Descriptive Statistics {-}

After removing all the missing values, the final sample size for analysis is 2761. Table 1 shows summaries of all quantitative variables. The minimum new cases from Feb 12, 2022 to Feb 19, 2022 are 0 for some counties, while the maximum is 5188.68 per 100K people. The mean is 333.95 and the standard deviation is 324.51 with the same unit, per 100K. The lowest booster rate is 0 while the highest is 70%. The mean of booster rate is 40.26% with standard deviation equal to 19.42. For Black, Hispanic, and Asian percent, respectively, their means are 9%, 10%, and 2%, their maximums are 86%, 96%, and 43%, and their minimums are similar. Population density has a large range from 0 to 27819.80 and thus a large standard deviation. Table 2 shows qualitative variables, metro status, and state. There are 2 levels in metro status and non-metro takes up more proportions. In this, the total number of states is 48. 

```{r,echo=FALSE,results='hide'}

# remove outliers
df_reg <- df_reg[-order(df_reg$new_cases, decreasing =TRUE)[1],]
max(df_reg$new_cases)

```

```{r,echo=FALSE, results='asis'}

# summary
tab_01 = data.frame(
  Variables = c("New Cases", "Booster Rate", "Black Percent", "Hispanic Percent" , "Asian Percent", "Population Density"),
  Min  = c(min(df_reg$new_cases),  min(df_reg$booster_vax_pct),  min(df_reg$black_pct),  min(df_reg$hispanic_pct),  min(df_reg$asian_pct), min(df_reg$pop_density)),
  Mean = c(mean(df_reg$new_cases), mean(df_reg$booster_vax_pct), mean(df_reg$black_pct), mean(df_reg$hispanic_pct), mean(df_reg$asian_pct), mean(df_reg$pop_density)),
  SD   = c(sd(df_reg$new_cases),   sd(df_reg$booster_vax_pct),   sd(df_reg$black_pct),   sd(df_reg$hispanic_pct),   sd(df_reg$asian_pct), sd(df_reg$pop_density)),
  Max  = c(max(df_reg$new_cases),  max(df_reg$booster_vax_pct),  max(df_reg$black_pct),  max(df_reg$hispanic_pct),  max(df_reg$asian_pct), max(df_reg$pop_density))
)

tab_01 %>%
  kbl(col.names = c("Quantitative Measures", "Min", "Mean", "SD", "Max"),
      digits = 2,
      caption = "Table1. Descriptive Statistics ($n=2761$)") %>%
  kable_classic(full_width = T, html_font = "Cambria")

tab_02 <- data.frame(table(df_reg$Metro_status)) 
tab_02$Prop <- round(tab_02$Freq/dim(df_reg)[1]*100,2)
tab_02$names <- c("Metro status", "")
tab_02 <- subset(tab_02, select=c(names, Var1, Freq, Prop))

tab_03 <- data.frame(table(df_reg$state)) 
tab_03$Prop <- round(tab_03$Freq/dim(df_reg)[1]*100,2)
tab_03$names <- c("State", rep("", 47))
tab_03 <- subset(tab_03, select=c(names, Var1, Freq, Prop))

tab_04 <- rbind(tab_02, tab_03)

tab_04 %>% 
  kbl(col.names = c("Qualitative Measures", "Level", "N", "%"),
      caption = "Table2. Continued Descriptive Statistics ($n=2761$)") %>%
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  scroll_box(height = "200px")

```

#### Multivariate Descriptive Statistics {-}

Figure 6 displays the distribution of new cases and its relationship with booster rate, state, and metro status. The count of new cases has a right skewed distribution with a long tail. The scatter plot of news cases and booster rate fails to show any clear trend. For the box plot of state, some states have significantly more new cases than the others; for the boxplot of metro status, it seems that non-metro tends to have more new cases than metro although the difference is not very clear. Figure 7 displays a scatter plot matrix for all quantitative variables. Among all the explanatory variables, no significant correlation is being detected. Looking at the plot diagonal, it is important to note that after taking log transformation on population density, its distribution becomes normal, otherwise the standard deviation is possibly influential.  

```{r,echo=FALSE}

g1 <- ggplot(df_reg, aes(x = new_cases)) + 
         geom_histogram(color="black", fill="white", bins=80) +
         xlab("new cases") +
         ggtitle("", subtitle="Weekly New Cases Per 100K People") +
         theme_classic() +
         theme_bw() +
         theme(panel.grid.major=element_blank(),
               panel.grid.minor=element_blank())

g2 <- ggplot(df_reg, aes(x = booster_vax_pct, y = new_cases)) + 
            geom_point() +
            geom_smooth(method=lm, se=FALSE) +
            xlab("booster rate")+
            ylab("count") +
            ggtitle("", subtitle="Weekly New Cases vs. Booster Rate") +
            theme_classic() +
            theme_bw() +
            theme(panel.grid.major=element_blank(),
                  panel.grid.minor=element_blank())

g3 <- ggplot(df_reg, aes(x = state, y = new_cases)) + 
            geom_boxplot() +
            xlab("state")+
            ylab("count") +
            ggtitle("", subtitle="Weekly New Cases vs. State") +
            theme_classic() +
            theme_bw() +
            theme(panel.grid.major=element_blank(),
                  panel.grid.minor=element_blank(),
                  axis.text.x = element_blank())

g4 <- ggplot(df_reg, aes(x = Metro_status, y = new_cases)) + 
            geom_boxplot() +
            xlab("metro status")+
            ylab("count") +
            ggtitle("", subtitle="Weekly New Cases vs. Metro_status") +
            theme_classic() +
            theme_bw() +
            theme(panel.grid.major=element_blank(),
                  panel.grid.minor=element_blank())

title=text_grob("Figure6. Exploratory Plots (I)", size = 14, face = "bold") 
grid.arrange(g1, g2, g3, g4, ncol=2, top = title)

panel.hist <- function(x, ...) {
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y)
}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) {
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y,use="pairwise.complete.obs"))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}
pairs(~ + new_cases + booster_vax_pct + black_pct + hispanic_pct + asian_pct + log(pop_density), data = df_reg, lower.panel = panel.cor, diag.panel = panel.hist, main="Figure7. Exploratory Plots (II)")


```

# Predictive Analysis {-}

### Linear Regression {-}

The question of interest in this project is to examine whether booster rate is related to weekly new cases. The proposed model for this question is multiple linear regression, which defined as: 

$Y_i=\beta_0+\beta_1X_{i1}+\beta_2X_{i2}+\dots +\beta_pX_{ip}+\varepsilon_i \text{ , i=1,...,n}$

where $Y_i$ is the value of response variable in the ith case, $X_{i1}, \dots,X_{ip}$ are the values of the explanatory variables in the ith case, $\beta_0, \beta_1, \dots, \beta_p$ are regression coefficients, and $\varepsilon_i$ are random errors which are i.i.d. $N(0,\sigma^2)$. Here, p is the number of explanatory variables, and n is the sample size. The linear regression has four assumptions, 1) linearity of regression relation (the relationship between Xs and Y is linear), 2) normality of error terms (the model residuals are normally distributed), 3) constant variance of error terms (the residuals have equal variance), and 4) independence of error terms (the residuals are independent). 

Specifically, in this project, $Y$ represents weekly new cases, $X_1, \dots,X_p$ are booster rate, Black percent, Hispanic percent, Asian percent, log-transformed population density, metro status, and state, respectively. For this method, I have two models:

$\text{ Model (1): }Y_i=\beta_0+\beta_1X_{i1}+\beta_7X_{i7}+\varepsilon_i \text{ , i=1,...,2761}$

$\text{ Model (2): }Y_i=\beta_0+\beta_1X_{i1}+\beta_2X_{i2}+\beta_3X_{i3}+\beta_4X_{i4}+\beta_5X_{i5}+\beta_6X_{i6}+\beta_7X_{i7}+\varepsilon_i \text{ , i=1,...,2761}$

where Model (1) is the reduced model and Model (2) is the full model. First, I test whether $X_{2},X_{3}, X_{4}, X_{5}, X_{6}$ may be dropped out from the full model. The null hypothesis (H0) is that all $\beta_2,\beta_3,\beta_4,\beta_5,\beta_6$ are equal to 0 and the alternative is that at least one of them is not 0. Based on the result shown in Table 3, p-value is 0, which is $< 0.05$, so H0 is rejected and conclude that the 5 variables should not be dropped from the full model. In addition, I do not test the interaction terms as I assume the effect of booster rate is not varied by state.

```{r,echo=FALSE, results='hide'}

df_reg$count <- round(df_reg$new_cases, 0)
df_reg$Metro_status <- relevel(as.factor(df_reg$Metro_status),"Metro")

# Linear regression on new cases
fit1 <- lm(count ~ booster_vax_pct + state, data = df_reg)
fit1.1 <- lm(count ~ booster_vax_pct + state +
                     black_pct + hispanic_pct + asian_pct +
                     log(pop_density) + Metro_status, data = df_reg)

anova(fit1)
anova(fit1.1)

perms1 <- aovp(count ~ booster_vax_pct + state, data = df_reg)
perms1.1 <- aovp(count ~ state + black_pct + hispanic_pct + asian_pct +
                     log(pop_density) + Metro_status + booster_vax_pct, data = df_reg)

perms <- lmp(count ~ booster_vax_pct + state +
                     black_pct + hispanic_pct + asian_pct +
                     log(pop_density) + Metro_status, data = df_reg)
summary(perms)

summary(perms1)
summary(perms1.1)

summary(fit1)
summary(fit1.1)

```

Next, I obtain ANOVA table for Model (2). The results in Table 4 show that the effect of booster rate were not significant if no variables were controlled. It is identical to the scatter plot in Figure 6 that there is no trend identified. However, when adding other explanatory variables, booster rate becomes significant. 

```{r, message=FALSE, echo=FALSE, results='asis'}

# ANOVA Test

anova1 <- anova(fit1, fit1.1)

options(knitr.kable.NA = '')

test1 <- round(anova1, 3)

test1 %>% 
  kbl(align = c("l", "c", "c","c", "c", "c"),
    caption = "Table3. ANOVA Test for Model (1) and (2)") %>%
  kable_classic(full_width = T, html_font = "Cambria")

anova1.1 <- anova(fit1.1)

test2 <- round(anova1.1, 3)
rownames(test2) <- c("Booster Rate", "State", "Black Percent", "Hispanic Percent", "Asian Percent", "log(Population Density)", "Metro Status", "Residuals")

test2 %>% 
  kbl(align = c("l", "c", "c", "c"),
    caption = "Table4. ANOVA Table for Model (2)") %>%
  kable_classic(full_width = T, html_font = "Cambria") 

```

The Table 5 displays the coefficients from Model (1) and Model (2) excluding the ones of state as state has 48 levels and they are not the variables of interest. The primary variable of interest is booster rate. In Model (1), its coefficient is $-2.093$ and it is significant, controlling for states. In Model (2), with more variables controlled, the coefficient is still significant, but becomes $-1.632$. We can interpret it as with one unit increase in booster rate, new cases decrease by 1.632 per 100K on average, when all other predictors are help constant. For other variables, Black percent and log-transformed population density are negatively associated with new cases, Hispanic percent is negatively associated with the outcome, and Asian percent is not statistically significant. Compared to metro, non-metro is related to more new cases.

```{r, message=FALSE, echo=FALSE, results='asis'}

# LM table
stargazer(fit1, fit1.1,  omit="state", type = "html",
  title = "Table5. Linear Regression Results", dep.var.labels="Weekly New Cases",
  covariate.labels = c("Booster Rate", "Black Percent", "Hispanic Percent", "Asian Percent",
                       "log(Population Density)", "Metro Status (ref = metro)"),
  column.sep.width="7",
  keep.stat=c("n", "rsq"), add.lines = list(c("AIC", round(AIC(fit1), 1), round(AIC(fit1.1), 1)), 
                                  c("BIC", round(BIC(fit1), 1), round(BIC(fit1.1), 1)))) 

```


Looking the diagnostic plots for Model (2) in Figure 8, the violation of model assumptions is observed. First, from the residuals vs fitted plot, we can see that the the relationship between outcome and predictors is not linear, and the residuals are not strictly constant. From the Q-Q plot, the normality of residuals are also violated. For these concerns, the results no long hold based on the parametric test. As a consequence, I perform a non-parametric permutation test for Model (2), which requires no distribution assumptions. The permutation test shows a consistent result in Table 6 that booster rate and other variables except Asian percent are significant.    

```{r, message=FALSE, echo=FALSE, results='hide'}

# Diagnostics
par(mfrow=c(1,2),oma=c(2,2,2,2),mar=c(4,3,3,3))
plot(fit1.1,1, sub.caption = "")
plot(fit1.1,2, sub.caption = "")
mtext("Figure8, Diagnostic Plots for Model (2)", side = 3, font=2, line=-1, outer=TRUE)

```

```{r, message=FALSE, echo=FALSE, results='asis'}

perm1.1 <- summary(perms1.1)

test2 <- round(perm1.1[[1]], 3)
rownames(test2) <- c("State", "Black Percent", "Hispanic Percent", "Asian Percent", "log(Population Density)", "Metro Status", "Booster Rate", "Residuals")

test2 %>% 
  kbl(align = c("c", "c", "c", "c", "c", "c"),
    caption = "Table6. Permutation Test for Model (2)") %>%
  kable_classic(full_width = T, html_font = "Cambria")

```


Therefore, the violation of normality can be reasonably ignored as the permutation test gives a consistent result. However, we still need to deal with the violation of linearity and unequal variance. As shown in Figure 6, the distribution of the outcome is right-skewed, which suggests that log-transformation on new cases may help to relieve the violation issues. Nevertheless, according to [O'Hara and Kotze](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.2041-210X.2010.00021.x), log-transformation on discrete counts is not recommended because count data often contain many zero cases. That is, taking log-transformation on the original outcome will make the zero cases lost. In my situation, after transforming the new cases, I got an almost perfect normal distribution, but the price is losing all zero observations. I would like to keep all the samples, so I also tried taking log-transformation on (Y+1), but the model diagnostics looked even worse.  

# Sensitivity Analysis {-}

Poisson and Negative Binomial regression are two types of regression models for discrete count data. If the variance and mean are equal, Poisson regression is appropriate; if the variance is significantly larger than the mean, Negative Binomial regression is appropriate. First, I need to decide which method I should use. The overdispersion test shows that overdispersion is detected in Table 7 and there fore suggests Negative Binomial regression. 

```{r, message=FALSE, echo=FALSE, results='hide'}

## Overdispersion test
fit0 <- glm(count ~ booster_vax_pct + state, family = "poisson", data = df_reg)
dispertest <- check_overdispersion(fit0)
dispertest

fit2 <- glm.nb(count ~ booster_vax_pct + state, data = df_reg)
pvalue <- pchisq(2 * (logLik(fit2) - logLik(fit0)), df = 1, lower.tail = FALSE)

```

```{r, message=FALSE, echo=FALSE, results='asis'}

dispertable <- data.frame(v1=c("Dispersion ratio", "Pearson's Chi-Squared", "P-value", NA),
                          v2=c("  ", "  ", "  ", "  "),
                          v3=c(" = ", " = ", " = ", NA),
                          v4=c(round(dispertest[[2]],3), round(dispertest[[1]],3), "< 0.001", "Overdispersion detected"))

options(knitr.kable.NA = '')
dispertable %>% 
  kbl(col.names = NULL,
  align = c("r", "r", "c","r"),
  caption = "Table7. Overdispersion Test") %>%
  kable_classic(full_width = F, html_font = "Cambria") 

```

### Negative Binomial Regression {-}

With similar process as I performed for linear regression, I first define Model (3) with booster rate and state and Model (4) with all explanatory variables in the data set. As Table 8 shows, the full model is better than the reduced model as the p-value is 0. ANOVA table for the full model, Model (4), in Table 9, shows that without controlling for other variables, booster rate is only marginally significant. Table 10 displays the coefficients of Negative Binomial Regression. The overall results are consistent that Booster rate, Black percent, and log-transformed population density are negatively related to the new cases, Hispanic percent is positively, and Asian percent is not significantly. Also, non-metro is associated with more new cases than metro. Specifically, I am interested in the relationship between new cases and booster rate. The coefficient of booster rate is $-0.003$, so we can interpret it as the percent change in the incident rate of new cases is a 0.3% decrease for every unit increase in booster rate. Looking at the Figure 9, the assumptions of linearity and constant variance are reasonably held. For the normality, this assumption is still violated, but as the sample size is sufficiently large, normality assumption becomes not that important due to the Central Limit Theorem.

```{r,echo=FALSE, results='hide'}

# Negative binomial regression on new cases
fit2 <- glm.nb(count ~ booster_vax_pct + state, data = df_reg)
fit2.1 <- glm.nb(count ~ booster_vax_pct + state +
                         black_pct + hispanic_pct + asian_pct +
                         log(pop_density) + Metro_status, data = df_reg)
anova(fit2)
summary(fit2)

anova(fit2.1)
summary(fit2.1)

```

```{r, message=FALSE, echo=FALSE, results='asis'}

anova2 <- anova(fit2, fit2.1)

options(knitr.kable.NA = '')

test3 <- cbind(anova2[3], anova2[4], anova2[5], anova2[6], anova2[7], anova2[8])

test3 %>% 
  kbl(align = c("l", "c", "c","c", "c", "c"),
    caption = "Table8. ANOVA Test for Model (3) and (4)") %>%
  kable_classic(full_width = T, html_font = "Cambria") 

anova2.1 <- anova(fit2.1)

test4 <- round(anova2.1, 3)
rownames(test4) <- c("NULL", "Booster Rate", "State", "Black Percent", "Hispanic Percent", "Asian Percent", "log(Population Density)", "Metro Status")

test4 %>% 
  kbl(align = c("l", "c", "c", "c"),
    caption = "Table9. ANOVA Table for Model (4)") %>%
  kable_classic(full_width = T, html_font = "Cambria") 

```

```{r, message=FALSE, echo=FALSE, results='asis'}

stargazer(fit2, fit2.1,  omit="state", type = "html",
  title = "Table10. Negative Binomial Regression Results", dep.var.labels="Weekly New Cases",
  covariate.labels = c("Booster Rate", "Black Percent", "Hispanic Percent", "Asian Percent", 
                       "log(Population Density)", "Metro Status (ref = metro)"),
  column.labels = c("(3)", "(4)"), model.numbers = FALSE,
  keep.stat="n", add.lines = list(c("AIC", round(AIC(fit2), 1), round(AIC(fit2.1), 1)), 
                                  c("BIC", round(BIC(fit2), 1), round(BIC(fit2.1), 1)))) 

```

```{r,echo=FALSE}

par(mfrow=c(1,2),oma=c(2,2,2,2),mar=c(4,3,3,3))
plot(fit2.1,1, sub.caption = "")
plot(fit2.1,2, sub.caption = "")
mtext("Figure9. Diagnostic Plots for Model (4)", side = 3, font=2, line=-1, outer=TRUE)

```

# Conclusion  {-}

Using Linear regression and Negative Binomial regression, I find that there is a significant negative effect of booster rate on weekly new cases at the county level in the U.S, when holding state, Black percent, Hispanic percent, log-transformed population density, and metro status constant. For the two methods, both of their normality assumption is violated. Although, the sample size is sufficiently large and the permutation test for the linear regression model suggests that it is not a issue, more test or techniques can be applied to deal with it or prove the validation. One of the caveats of this report is omitted variables. More demographic features can be included in the models. The results of the project shows that the booster is still effective against COVID-19, it may encourage people who are not boostered to have their booster dose on schedule.

# Appendix {-}

https://github.com/mingzhao1103/sta207/blob/main/final_project_MingZhao.Rmd

